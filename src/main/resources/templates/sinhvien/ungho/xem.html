<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="sinhvien/layouts/header::header"></head>

<body>
  <nav th:replace="sinhvien/layouts/navBar::navBar"></nav>

  <main class="container px-4 px-lg-5 my-5">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-10">

        <div class="card border-0 shadow-sm">
          <div class="card-body p-4 p-lg-5" th:if="${u != null}">

            <!-- Header -->
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
              <div class="text-muted small">
                <i class="fa-regular fa-clock me-1"></i>
                <span th:text="${u.taoLuc != null ? #temporals.format(u.taoLuc,'dd/MM/yyyy HH:mm') : ''}"></span>
              </div>

              <a class="btn btn-sm btn-outline-secondary" th:href="@{/UngHo}">
                <i class="fa-solid fa-arrow-left me-1"></i> Quay lại
              </a>
            </div>

            <h1 class="fw-bold mb-3" th:text="${u.tieuDe}">Tiêu đề ủng hộ</h1>

            <!-- Meta -->
            <div class="d-flex flex-wrap gap-2 mb-4">
              <span class="badge rounded-pill text-bg-light border">
                <i class="fa-solid fa-bullseye me-1"></i>
                Mục tiêu:
                <b class="ms-1" th:text="${#numbers.formatDecimal(u.mucTieuVnd,0,'COMMA',0,'POINT')} + ' ₫'">0 ₫</b>
              </span>

              <span class="badge rounded-pill text-bg-light border">
                <i class="fa-solid fa-sack-dollar me-1"></i>
                Đã nhận:
                <b class="ms-1" th:text="${#numbers.formatDecimal(u.daNhanVnd,0,'COMMA',0,'POINT')} + ' ₫'">0 ₫</b>
              </span>

              <span class="badge rounded-pill"
                    th:classappend="${u.trangThai} ? ' text-bg-success' : ' text-bg-secondary'"
                    th:text="${u.trangThai} ? 'Đang mở' : 'Đã đóng'">
                Đang mở
              </span>
            </div>

            <!-- progress -->
            <div class="mb-4">
              <div class="progress" style="height: 12px;">
                <div class="progress-bar"
                     role="progressbar"
                     th:with="pct=${u.mucTieuVnd != null and u.mucTieuVnd > 0 ? (u.daNhanVnd * 100.0 / u.mucTieuVnd) : 0}"
                     th:style="'width:' + (${pct > 100 ? 100 : pct}) + '%;'">
                </div>
              </div>
              <div class="text-muted small mt-1"
                   th:with="pct=${u.mucTieuVnd != null and u.mucTieuVnd > 0 ? (u.daNhanVnd * 100.0 / u.mucTieuVnd) : 0}"
                   th:text="${#numbers.formatDecimal(pct,1,'POINT',1,'POINT')} + '%'">
                0%
              </div>
            </div>

            <hr class="my-4">

            <!-- Nội dung -->
            <div class="mb-4">
              <p class="mb-0 text-muted" style="white-space:pre-line;" th:text="${u.moTa}">
                Mô tả chiến dịch...
              </p>
            </div>

            <hr class="my-4">

            <!-- Donate form -->
            <div>
              <h5 class="fw-semibold mb-2">
                <i class="fa-solid fa-money-bill-wave me-1"></i> Ủng hộ qua VNPAY
              </h5>
              <div class="text-muted small mb-3">
                Thanh toán online qua VNPAY. Tối thiểu 10.000₫.
              </div>

              <!-- Nếu muốn bắt login: giữ form trong sec:authorize -->
              <div sec:authorize="isAuthenticated()">
                <form th:action="@{/UngHo/{id}/donate(id=${u.ungHoId})}" method="post" class="needs-validation" novalidate>

                  <div class="row g-3 align-items-end">
                    <div class="col-12 col-md-4">
                      <label class="form-label">Số tiền (VND)</label>
                      <input class="form-control"
                             name="soTienVnd"
                             type="number"
                             min="10000"
                             
                             placeholder="10000"
                             required>
                      <div class="invalid-feedback">Vui lòng nhập số tiền hợp lệ (>= 10.000).</div>
                    </div>
                    <input type="hidden" ch:text="${}">
                    <div class="col-12 col-md-6">
                      <label class="form-label">Lời nhắn (tuỳ chọn)</label>
                      <input class="form-control" name="noiDung" maxlength="200"
                             placeholder="Ví dụ: Chúc chương trình thành công!">
                    </div>

                    <div class="col-12 col-md-2 d-grid">
                      <button class="btn btn-primary"
                              type="submit"
                              th:disabled="${u.trangThai == false}">
                        <i class="fa-solid fa-qrcode me-1"></i> VNPAY
                      </button>
                    </div>
                  </div>

                </form>
              </div>

              <!-- Nếu chưa đăng nhập -->
              <div sec:authorize="!isAuthenticated()">
                <div class="alert alert-light border">
                  Bạn cần <a th:href="@{/login}" class="fw-semibold">đăng nhập</a> để ủng hộ.
                </div>
              </div>

              <script>
                (() => {
                  const forms = document.querySelectorAll('.needs-validation');
                  Array.from(forms).forEach(form => {
                    form.addEventListener('submit', event => {
                      if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                      }
                      form.classList.add('was-validated');
                    }, false);
                  });
                })();
              </script>

            </div>

          </div>

          <!-- u null -->
          <div class="card-body p-4 p-lg-5" th:if="${u == null}">
            <div class="text-center text-muted">Không tìm thấy chiến dịch ủng hộ.</div>
          </div>
<hr class="my-4">

<!-- ===================== GIAO DỊCH ỦNG HỘ ===================== -->
<section>
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
    <h5 class="fw-semibold mb-0">
      <i class="fa-solid fa-receipt me-1"></i> Giao dịch ủng hộ
    </h5>
    <span class="text-muted small" th:if="${trangThai != null}">
      (lọc: <b th:text="${trangThai}">ALL</b>)
    </span>
  </div>

  <!-- Filter (tuỳ chọn giống admin) -->
  <form method="get" th:action="@{/UngHo/{id}(id=${u.ungHoId})}" class="mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-12 col-md-4">
        <label class="form-label mb-1 small text-muted">Trạng thái</label>
        <select class="form-select" name="trangThai">
          <option value="ALL" th:selected="${trangThai == 'ALL'}">Tất cả</option>
          <option value="SUCCESS" th:selected="${trangThai == 'SUCCESS'}">SUCCESS</option>
          <option value="PENDING" th:selected="${trangThai == 'PENDING'}">PENDING</option>
          <option value="FAILED" th:selected="${trangThai == 'FAILED'}">FAILED</option>
          <option value="CANCELLED" th:selected="${trangThai == 'CANCELLED'}">CANCELLED</option>
        </select>
      </div>

      <div class="col-12 col-md-3 d-grid">
        <button class="btn btn-primary" type="submit">
          <i class="fa-solid fa-filter me-1"></i>Lọc
        </button>
      </div>
    </div>
  </form>

  <div class="card border-0 shadow-sm">
    <div class="card-body p-0">

      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width:90px;">GD</th>
              <th style="min-width:180px;">Mã đơn</th>
              <th style="min-width:140px;" class="text-end">Số tiền</th>
              <th style="min-width:130px;">Trạng thái</th>
              <th style="min-width:170px;">Thời gian</th>
              <th style="min-width:120px;">Bank</th>
              <th style="min-width:120px;">Resp</th>
            </tr>
          </thead>

          <tbody>
            <tr th:each="g : ${dsGiaoDich}">
              <td class="fw-semibold text-nowrap" th:text="${g.gdId}">1</td>

              <td class="min-w-0">
                <div class="fw-semibold text-truncate" style="max-width: 320px;"
                     th:text="${g.maDonHang}">UH...</div>
                <div class="text-muted small text-truncate" style="max-width: 320px;"
                     th:text="${g.vnpTxnRef}">vnpTxnRef</div>
              </td>

              <td class="text-end text-nowrap"
                  th:text="${#numbers.formatDecimal(g.soTienVnd,0,'COMMA',0,'POINT')} + ' ₫'">0 ₫</td>

              <td class="text-nowrap">
                <span class="badge rounded-pill"
                      th:classappend="${g.trangThai == 'SUCCESS'} ? ' bg-success'
                        : (${g.trangThai == 'PENDING'} ? ' bg-warning text-dark'
                        : (${g.trangThai == 'FAILED'} ? ' bg-danger' : ' bg-secondary'))"
                      th:text="${g.trangThai}">
                  PENDING
                </span>
              </td>

              <td class="text-nowrap"
                  th:text="${g.taoLuc != null ? #temporals.format(g.taoLuc,'dd/MM/yyyy HH:mm') : ''}">
                09/01/2026 10:10
              </td>

              <td class="text-nowrap" th:text="${g.vnpBankCode}">NCB</td>
              <td class="text-nowrap" th:text="${g.vnpResponseCode}">00</td>
            </tr>

            <tr th:if="${dsGiaoDich == null or #lists.isEmpty(dsGiaoDich)}">
              <td colspan="7" class="text-center text-muted py-4">
                Chưa có giao dịch.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="d-flex justify-content-center my-3"
           th:if="${totalpage != null and totalpage > 1}">
        <nav aria-label="Pagination">
          <ul class="pagination mb-0">
            <li class="page-item" th:classappend="${currentpage == 1} ? 'disabled'">
              <a class="page-link"
                 th:href="@{/UngHo/{id}(id=${u.ungHoId}, pageNo=${currentpage-1}, trangThai=${trangThai})}">
                <i class="fa-solid fa-chevron-left me-1"></i>Previous
              </a>
            </li>

            <li class="page-item"
                th:each="i : ${#numbers.sequence(1,totalpage)}"
                th:classappend="${i == currentpage} ? 'active'">
              <a class="page-link"
                 th:href="@{/UngHo/{id}(id=${u.ungHoId}, pageNo=${i}, trangThai=${trangThai})}"
                 th:text="${i}">1</a>
            </li>

            <li class="page-item" th:classappend="${currentpage == totalpage} ? 'disabled'">
              <a class="page-link"
                 th:href="@{/UngHo/{id}(id=${u.ungHoId}, pageNo=${currentpage+1}, trangThai=${trangThai})}">
                Next<i class="fa-solid fa-chevron-right ms-1"></i>
              </a>
            </li>
          </ul>
        </nav>
      </div>

    </div>
  </div>
</section>

        </div>

      </div>
    </div>
  </main>

  <footer th:replace="sinhvien/layouts/footer::footer"></footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <script th:src="@{/assets/js/sinhvien.js}"></script>
</body>
</html>
