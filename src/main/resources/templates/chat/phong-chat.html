<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="sinhvien/layouts/header::header"></head>

<body class="d-flex flex-column min-vh-100">
<nav th:replace="sinhvien/layouts/navBar::navBar"></nav>

<main class="container px-4 px-lg-5 my-4">



  <!-- CHAT CARD -->
  <div class="card border-0 shadow-sm overflow-hidden chat-card">

   <!-- HEADER -->
<div class="card-header bg-white border-0 py-3">
  <div class="d-flex align-items-center justify-content-between gap-2">

    <!-- LEFT: Back + Avatar + Name -->
    <div class="d-flex align-items-center gap-2 min-w-0">

      <!-- Nút quay lại -->
      <a class="btn btn-sm btn-outline-secondary px-2" th:href="@{/chat}">
        <i class="fa-solid fa-arrow-left"></i>
      </a>

      <!-- Avatar + tên người dùng -->
      <div class="d-flex align-items-center gap-2 min-w-0">
        <div class="chat-avatar"
             th:text="${#strings.substring(me.hoTen,0,1)}">M</div>
        <div class="min-w-0">
          <div class="fw-semibold text-truncate"
               th:text="${me.hoTen}">Tên của tôi</div>
          <div class="text-muted small">Đang trò chuyện</div>
        </div>
      </div>

    </div>

    <!-- RIGHT: WS status -->
    <div class="text-muted small text-nowrap" id="wsStatus">
      WS: đang kết nối...
    </div>

  </div>
</div>


    <input type="hidden" id="cuocId" th:value="${cuocId}">
    <input type="hidden" id="meId" th:value="${me.nguoiDungId}">

    <!-- BODY -->
    <div id="msgs" class="card-body chat-body">

      <!-- LỊCH SỬ (SSR) -->
      <div th:each="m : ${lichSu}"
           class="msg-row"
           th:attr="data-sender-id=${m.nguoiGui.nguoiDungId},
                    data-sender-name=${m.nguoiGui.hoTen},
                    data-sent-at=${m.taoLuc}">
        <div class="bubble">
          <div class="msg-name" th:text="${m.nguoiGui.hoTen}">Tên</div>
          <div class="msg-text" th:text="${m.noiDung}">Nội dung</div>
          <div class="msg-time" th:text="${#temporals.format(m.taoLuc, 'HH:mm dd/MM/yyyy')}"></div>
        </div>
      </div>

    </div>

    <!-- FOOTER -->
    <div class="card-footer bg-white border-0 chat-bottom">
      <div class="d-flex gap-2 align-items-center">
        <input id="text" class="form-control chat-input" placeholder="Nhập tin nhắn..." autocomplete="off"/>
        <button class="btn btn-primary chat-send" type="button" id="btnSend">
          <i class="fa-regular fa-paper-plane me-1"></i> Gửi
        </button>
      </div>
      <div class="text-muted small mt-2 d-none" id="wsStatusBottom"></div>
    </div>

  </div>

</main>

<footer th:replace="sinhvien/layouts/footer::footer"></footer>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/assets/js/sinhvien.js}"></script>

<style>
  .chat-card{ border-radius: 16px; }

  .chat-avatar{
    width: 40px; height: 40px; border-radius: 50%;
    display:flex; align-items:center; justify-content:center;
    font-weight: 800;
    background: #e8f2ff;
    color: #0b255a;
    border: 1px solid rgba(13,110,253,.18);
    flex: 0 0 auto;
  }

  .chat-body{
    height: 68vh;
    overflow:auto;
    background: #f6f7fb;
    padding: 14px 12px;
    scroll-behavior: smooth;
  }

  .msg-row{ display:flex; margin: 10px 0; }
  .msg-row.me{ justify-content:flex-end; }
  .msg-row.other{ justify-content:flex-start; }

  .bubble{
    max-width: min(78%, 720px);
    padding: 10px 12px;
    border-radius: 16px;
    border: 1px solid rgba(0,0,0,.06);
    box-shadow: 0 6px 14px rgba(0,0,0,.06);
    word-break: break-word;
    background:#fff;
  }

  .msg-row.me .bubble{
    background:#e8f2ff;
    border-color: rgba(13,110,253,.18);
    color:#0b255a;
  }

  .msg-name{
    font-weight: 700;
    font-size: 13px;
    margin-bottom: 4px;
    opacity: .95;
  }

  .msg-text{ font-size: 14px; line-height: 1.45; }
  .msg-time{
    font-size: 11px;
    color:#6b7280;
    margin-top: 6px;
  }
  .msg-row.me .msg-time{ text-align:right; }

  .chat-bottom{ padding: 12px; }

  .chat-input{ border-radius: 12px; }
  .chat-send{ border-radius: 12px; font-weight: 700; white-space: nowrap; }
</style>

<script>
  const cuocId = Number(document.getElementById("cuocId").value);
  const meId   = Number(document.getElementById("meId").value);

  const msgsEl   = document.getElementById("msgs");
  const inputEl  = document.getElementById("text");
  const btnSend  = document.getElementById("btnSend");
  const wsStatus = document.getElementById("wsStatus");

  const nameMap = new Map();

  // Fix class trái/phải cho lịch sử
  initHistory();

  function initHistory(){
    const rows = msgsEl.querySelectorAll(".msg-row[data-sender-id]");
    rows.forEach(row => {
      const senderId = Number(row.getAttribute("data-sender-id") || 0);
      const senderName = (row.getAttribute("data-sender-name") || "").trim();

      if(senderId && senderName) nameMap.set(senderId, senderName);

      row.classList.remove("me","other");
      row.classList.add(senderId === meId ? "me" : "other");
    });

    scrollBottom();
  }

  // WS connect
  const sock = new SockJS("/ws");
  const stomp = Stomp.over(sock);
  stomp.debug = null;

  stomp.connect({}, onConnected, onError);

  function onConnected(){
    wsStatus.textContent = "WS: đã kết nối";

    stomp.subscribe("/topic/chat." + cuocId, (frame) => {
      const m = JSON.parse(frame.body);
      appendFromWs(m);
    });
  }

  function onError(){
    wsStatus.textContent = "WS: lỗi kết nối";
  }

  // Append từ WS
  function appendFromWs(m){
    const senderId   = Number(m.nguoiGuiId || 0);
    const senderName = (m.tenNguoiGui || nameMap.get(senderId) || ("User#" + senderId));
    const content    = (m.noiDung || "").trim();
    const sentAt     = m.taoLuc || "";

    if(senderId && senderName && !senderName.startsWith("User#")){
      nameMap.set(senderId, senderName);
    }

    const row = document.createElement("div");
    row.className = "msg-row " + (senderId === meId ? "me" : "other");

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.innerHTML = `
      <div class="msg-name">${escapeHtml(senderName)}</div>
      <div class="msg-text">${escapeHtml(content)}</div>
      <div class="msg-time">${escapeHtml(formatTime(sentAt))}</div>
    `;

    row.appendChild(bubble);
    msgsEl.appendChild(row);
    scrollBottom();
  }

  // Send
  btnSend.addEventListener("click", sendMsg);
  inputEl.addEventListener("keydown", (e) => {
    if(e.key === "Enter") sendMsg();
  });

  function sendMsg(){
    const content = inputEl.value.trim();
    if(!content) return;

    if(!stomp.connected){
      wsStatus.textContent = "WS: chưa kết nối";
      return;
    }

    stomp.send("/app/chat.gui", {}, JSON.stringify({
      cuocTroChuyenId: cuocId,
      noiDung: content
    }));

    inputEl.value = "";
    inputEl.focus();
  }

  function scrollBottom(){
    msgsEl.scrollTop = msgsEl.scrollHeight;
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }

  function formatTime(iso){
    if(!iso) return "";
    const d = new Date(iso);
    if(isNaN(d.getTime())) return iso;
    return d.toLocaleString();
  }
</script>

</body>
</html>
