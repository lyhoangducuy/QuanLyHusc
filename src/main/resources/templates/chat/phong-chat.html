<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="sinhvien/layouts/header::header"></head>

<body>
<nav th:replace="sinhvien/layouts/navBar::navBar"></nav>

<main class="container px-4 px-lg-5 my-4">

  <!-- TOP BAR -->
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <a class="btn btn-sm btn-outline-secondary" th:href="@{/chat}">← Danh sách</a>

    <div class="text-muted small">
      Cuộc trò chuyện ID: <b th:text="${cuocId}"></b>
    </div>
  </div>

  <div class="chat-card">
    <!-- HEADER CHAT -->
    <div class="chat-top">
      <div class="chat-user">
        <div class="chat-avatar" th:text="${#strings.substring(me.hoTen,0,1)}">M</div>
        <div class="chat-user-info">
          <div class="chat-user-name" th:text="${me.hoTen}">Tên của tôi</div>
          <div class="chat-user-sub">Đang hoạt động</div>
        </div>
      </div>
    </div>

    <input type="hidden" id="cuocId" th:value="${cuocId}">
    <input type="hidden" id="meId" th:value="${me.nguoiDungId}">

    <!-- BODY -->
    <div id="msgs" class="chat-body">

      <!-- LỊCH SỬ (SSR) -->
      <div th:each="m : ${lichSu}"
           class="msg-row"
           th:attr="data-sender-id=${m.nguoiGui.nguoiDungId},
                    data-sender-name=${m.nguoiGui.hoTen},
                    data-sent-at=${m.taoLuc}">

        <div class="bubble">
          <div class="msg-name" th:text="${m.nguoiGui.hoTen}">Tên</div>
          <div class="msg-text" th:text="${m.noiDung}">Nội dung</div>
          <div class="msg-time" th:text="${#temporals.format(m.taoLuc, 'HH:mm dd/MM/yyyy')}"></div>
        </div>
      </div>

    </div>

    <!-- FOOTER INPUT -->
    <div class="chat-bottom">
      <div class="chat-input-wrap">
        <input id="text" class="chat-input" placeholder="Nhập tin nhắn..." autocomplete="off"/>
        <button class="chat-send" type="button" id="btnSend">Gửi</button>
      </div>
      <div class="chat-status" id="wsStatus">WS: đang kết nối...</div>
    </div>
  </div>

</main>

<footer th:replace="sinhvien/layouts/footer::footer"></footer>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/assets/js/sinhvien.js}"></script>

<style>
  /* ===== Card tổng kiểu Zalo ===== */
  .chat-card{
    border-radius: 18px;
    overflow: hidden;
    background: #fff;
    border: 1px solid rgba(0,0,0,.06);
    box-shadow: 0 10px 26px rgba(0,0,0,.08);
  }

  /* ===== Header ===== */
  .chat-top{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding: 14px 16px;
    background: #ffffff;
    border-bottom: 1px solid rgba(0,0,0,.06);
  }

  .chat-user{
    display:flex;
    gap: 10px;
    align-items:center;
  }

  .chat-avatar{
    width: 42px;
    height: 42px;
    border-radius: 50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight: 800;
    color: #0b255a;
    background: #e8f2ff;
    border: 1px solid rgba(60,130,255,.22);
  }

  .chat-user-name{
    font-weight: 800;
    font-size: 15px;
    line-height: 1.2;
  }

  .chat-user-sub{
    font-size: 12px;
    color: #6b7280;
    margin-top: 2px;
  }

  /* ===== Body chat ===== */
  .chat-body{
    height: 70vh;
    overflow:auto;
    padding: 14px 12px;
    background: linear-gradient(180deg, #f5f8ff 0%, #fafafa 100%);
    scroll-behavior: smooth;
  }

  /* ===== Row ===== */
  .msg-row{
    display:flex;
    margin: 10px 0;
  }

  .msg-row.me{ justify-content:flex-end; }
  .msg-row.other{ justify-content:flex-start; }

  /* ===== Bubble ===== */
  .bubble{
    max-width: min(74%, 700px);
    padding: 10px 12px;
    border-radius: 18px;
    position: relative;
    border: 1px solid rgba(0,0,0,.06);
    box-shadow: 0 6px 18px rgba(0,0,0,.06);
    word-break: break-word;
  }

  /* other: trái - trắng */
  .msg-row.other .bubble{
    background:#fff;
    color:#111827;
  }
  .msg-row.other .bubble::before{
    content:"";
    position:absolute;
    left:-6px;
    bottom: 12px;
    width: 12px;
    height: 12px;
    background:#fff;
    border-left:1px solid rgba(0,0,0,.06);
    border-bottom:1px solid rgba(0,0,0,.06);
    transform: rotate(45deg);
  }

  /* me: phải - xanh */
  .msg-row.me .bubble{
    background:#e8f2ff;
    border-color: rgba(60,130,255,.22);
    color:#0b255a;
  }
  .msg-row.me .bubble::before{
    content:"";
    position:absolute;
    right:-6px;
    bottom: 12px;
    width: 12px;
    height: 12px;
    background:#e8f2ff;
    border-right:1px solid rgba(60,130,255,.22);
    border-bottom:1px solid rgba(60,130,255,.22);
    transform: rotate(-45deg);
  }

  /* ===== Name / Text / Time ===== */
  .msg-name{
    font-weight: 800;
    font-size: 15px;   /* to hơn nội dung */
    line-height: 1.2;
    margin-bottom: 4px;
  }
  .msg-text{
    font-size: 13px;
    line-height: 1.45;
  }
  .msg-time{
    font-size: 11px;
    color:#6b7280;
    margin-top: 6px;
    opacity: .9;
  }
  .msg-row.me .msg-time{ text-align:right; }
  .msg-row.other .msg-time{ text-align:left; }

  /* ===== Footer ===== */
  .chat-bottom{
    padding: 10px 12px;
    background:#fff;
    border-top: 1px solid rgba(0,0,0,.06);
  }

  .chat-input-wrap{
    display:flex;
    gap: 10px;
    align-items:center;
    padding: 8px 10px;
    border: 1px solid rgba(0,0,0,.08);
    border-radius: 14px;
    background:#fff;
  }

  .chat-input{
    flex: 1;
    border: 0;
    outline: none;
    box-shadow: none;
    font-size: 14px;
  }

  .chat-send{
    border: 0;
    border-radius: 12px;
    padding: 8px 14px;
    background: #0d6efd;
    color: #fff;
    font-weight: 700;
  }
  .chat-send:active{ transform: translateY(1px); }

  .chat-status{
    margin-top: 8px;
    font-size: 12px;
    color:#6b7280;
  }
</style>

<script>
  const cuocId = Number(document.getElementById("cuocId").value);
  const meId   = Number(document.getElementById("meId").value);

  const msgsEl   = document.getElementById("msgs");
  const inputEl  = document.getElementById("text");
  const btnSend  = document.getElementById("btnSend");
  const wsStatus = document.getElementById("wsStatus");

  // nhớ tên theo id để khỏi User#...
  const nameMap = new Map();

  // ===== 1) Fix class trái/phải cho lịch sử (quan trọng: F5 không lệch) =====
  initHistory();

  function initHistory(){
    const rows = msgsEl.querySelectorAll(".msg-row[data-sender-id]");
    rows.forEach(row => {
      const senderId = Number(row.getAttribute("data-sender-id") || 0);
      const senderName = (row.getAttribute("data-sender-name") || "").trim();

      if(senderId && senderName) nameMap.set(senderId, senderName);

      row.classList.remove("me","other");
      row.classList.add(senderId === meId ? "me" : "other");
    });

    scrollBottom();
  }

  // ===== 2) WS connect =====
  const sock = new SockJS("/ws");
  const stomp = Stomp.over(sock);
  stomp.debug = null;

  stomp.connect({}, onConnected, onError);

  function onConnected(){
    wsStatus.textContent = "WS: đã kết nối";

    const topic = "/topic/chat." + cuocId;
    stomp.subscribe(topic, (frame) => {
      const m = JSON.parse(frame.body);
      appendFromWs(m);
    });
  }

  function onError(){
    wsStatus.textContent = "WS: lỗi kết nối";
  }

  // ===== 3) Append tin nhắn từ WS =====
  function appendFromWs(m){
    const senderId   = Number(m.nguoiGuiId || 0);
    const senderName = (m.tenNguoiGui || nameMap.get(senderId) || ("User#" + senderId));
    const content    = (m.noiDung || "").trim();
    const sentAt     = m.taoLuc || "";

    if(senderId && senderName && !senderName.startsWith("User#")){
      nameMap.set(senderId, senderName);
    }

    const row = document.createElement("div");
    row.className = "msg-row " + (senderId === meId ? "me" : "other");

    const bubble = document.createElement("div");
    bubble.className = "bubble";

    bubble.innerHTML = `
      <div class="msg-name">${escapeHtml(senderName)}</div>
      <div class="msg-text">${escapeHtml(content)}</div>
      <div class="msg-time">${escapeHtml(formatTime(sentAt))}</div>
    `;

    row.appendChild(bubble);
    msgsEl.appendChild(row);
    scrollBottom();
  }

  // ===== 4) Send =====
  btnSend.addEventListener("click", sendMsg);
  inputEl.addEventListener("keydown", (e) => {
    if(e.key === "Enter") sendMsg();
  });

  function sendMsg(){
    const content = inputEl.value.trim();
    if(!content) return;

    if(!stomp.connected){
      wsStatus.textContent = "WS: chưa kết nối";
      return;
    }

    stomp.send("/app/chat.gui", {}, JSON.stringify({
      cuocTroChuyenId: cuocId,
      noiDung: content
    }));

    inputEl.value = "";
    inputEl.focus();
  }

  // ===== helpers =====
  function scrollBottom(){
    msgsEl.scrollTop = msgsEl.scrollHeight;
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }

  function formatTime(iso){
    if(!iso) return "";
    const d = new Date(iso);
    if(isNaN(d.getTime())) return iso;
    return d.toLocaleString();
  }
</script>

</body>
</html>
