<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="admin/layouts/header::header"></head>

<body class="sb-nav-fixed">
  <nav th:replace="admin/layouts/navBar::navBar"></nav>

  <div id="layoutSidenav">
    <div th:replace="admin/layouts/sideBar::sideBar"></div>

    <div id="layoutSidenav_content">
      <main>
        <div class="container-fluid px-4 mt-4">

          <!-- TOP BAR -->
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
            <div>
              <div class="text-muted small">Chỉnh sửa bài viết</div>
              <h3 class="fw-semibold mb-0" th:text="${baiViet.tieuDe}">Tiêu đề</h3>
            </div>

            <div class="d-flex gap-2">
              <a class="btn btn-sm btn-outline-secondary" th:href="@{/admin/BaiViet}">
                <i class="fa-solid fa-arrow-left me-1"></i> Quay lại
              </a>

              <button form="formSuaBaiViet" type="submit" class="btn btn-sm btn-primary">
                <i class="fa-solid fa-floppy-disk me-1"></i> Lưu
              </button>
            </div>
          </div>

          <!-- FORM -->
          <form id="formSuaBaiViet" class="needs-validation" novalidate method="post" enctype="multipart/form-data"
            th:action="@{/admin/BaiViet/sua/{id}(id=${baiViet.baiVietId})}">

            <div class="row g-4">

              <!-- LEFT: THÔNG TIN BÀI VIẾT -->
              <div class="col-12 col-lg-8">
                <div class="card shadow-sm border-0">
                  <div class="card-header bg-white">
                    <div class="fw-semibold">
                      <i class="fa-regular fa-file-lines me-1"></i> Thông tin bài viết
                    </div>
                  </div>

                  <div class="card-body">

                    <div class="mb-3">
                      <label class="form-label fw-semibold">Tiêu đề</label>
                      <input type="text" class="form-control" name="tieuDe" th:value="${baiViet.tieuDe}" required>
                      <div class="invalid-feedback">Vui lòng nhập tiêu đề.</div>
                    </div>

                    <div class="row g-3">
                      <div class="col-12 col-md-6">
                        <label class="form-label fw-semibold">Tác giả</label>
                        <input type="text" class="form-control" readonly
                          th:value="${baiViet.tacGiaId != null ? baiViet.tacGiaId.tenDangNhap : ''}">
                      </div>
                    </div>

                    <div class="mt-3">
                      <label class="form-label fw-semibold">Nội dung</label>
                      <textarea class="form-control" name="noiDung" rows="10" required
                        th:text="${baiViet.noiDung}"></textarea>
                      <div class="invalid-feedback">Vui lòng nhập nội dung.</div>
                    </div>

                    <div class="mt-3 form-check">
                      <input type="checkbox" class="form-check-input" id="ghim" name="ghim"
                        th:checked="${baiViet.ghim}">
                      <label class="form-check-label fw-semibold" for="ghim">Ghim</label>
                    </div>

                    <hr class="my-4">

                    <div class="row g-3">
                      <div class="col-12 col-md-6">
                        <label class="form-label fw-semibold">Tạo lúc</label>
                        <input type="text" class="form-control" readonly
                          th:value="${baiViet.taoLuc != null ? #temporals.format(baiViet.taoLuc,'dd/MM/yyyy HH:mm') : ''}">
                      </div>

                      <div class="col-12 col-md-6">
                        <label class="form-label fw-semibold">Cập nhật lúc</label>
                        <input type="text" class="form-control" readonly
                          th:value="${baiViet.capNhatLuc != null ? #temporals.format(baiViet.capNhatLuc,'dd/MM/yyyy HH:mm') : ''}">
                      </div>
                    </div>

                  </div>
                </div>
              </div>

              <!-- RIGHT -->
              <div class="col-12 col-lg-4">

                <!-- DANH MỤC -->
                <div class="card shadow-sm border-0 mb-4">
                  <div class="card-header bg-white d-flex align-items-center justify-content-between">
                    <div class="fw-semibold">
                      <i class="fa-solid fa-list me-1"></i> Danh mục
                    </div>

                    <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal"
                      data-bs-target="#modalDanhMuc">
                      <i class="fa-solid fa-plus me-1"></i> Thêm
                    </button>
                  </div>

                  <div class="card-body">
                    <!-- Chips -->
                    <div id="chipWrap" class="d-flex flex-wrap gap-2">
                      <div class="badge rounded-pill text-bg-light border d-inline-flex align-items-center gap-2"
                        th:each="bvdm : ${baiViet.dsDanhMuc}" th:if="${bvdm.danhMuc != null}"
                        th:attr="data-id=${bvdm.danhMuc.danhMucId}">
                        <span th:text="${bvdm.danhMuc.tenDanhMuc}">Tên</span>
                        <button type="button" class="btn-close btn-close-sm js-remove-chip"
                          aria-label="Remove"></button>
                      </div>
                    </div>

                    <div class="text-muted small mt-2"
                      th:if="${baiViet.dsDanhMuc == null or #sets.isEmpty(baiViet.dsDanhMuc)}">
                      Chưa chọn danh mục.
                    </div>

                    <!-- Hidden inputs để submit -->
                    <div id="dmHidden">
                      <input type="hidden" name="danhMucIds" th:each="id : ${selectedDanhMucIds}" th:value="${id}">
                    </div>
                  </div>
                </div>

                <!-- MODAL CHỌN DANH MỤC -->
                <div class="modal fade" id="modalDanhMuc" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-scrollable">
                    <div class="modal-content">

                      <div class="modal-header">
                        <h5 class="modal-title">Chọn danh mục</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>

                      <div class="modal-body">
                        <div class="d-flex flex-column gap-2">
                          <div class="border rounded-3 p-2 d-flex align-items-center gap-2" th:each="dm : ${dsDanhMuc}">
                            <input class="form-check-input m-0 dm-checkbox"  type="checkbox" th:id="|dm_${dm.danhMucId}|"
                              th:value="${dm.danhMucId}"
                              th:checked="${selectedDanhMucIds != null and selectedDanhMucIds.contains(dm.danhMucId)}">

                            <label class="m-0 flex-grow-1" th:for="|dm_${dm.danhMucId}|" th:text="${dm.tenDanhMuc}">
                              Tên danh mục
                            </label>
                          </div>
                        </div>
                      </div>

                      <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="button" class="btn btn-primary" id="btnApDungDm" data-bs-dismiss="modal">
                          Áp dụng
                        </button>
                      </div>

                    </div>
                  </div>
                </div>

                <!-- FILE ĐÍNH KÈM -->
                <div class="card shadow-sm border-0">
                  <div class="card-header bg-white d-flex align-items-center justify-content-between">
                    <div class="fw-semibold">
                      <i class="fa-solid fa-paperclip me-1"></i> Tệp đính kèm
                    </div>

                    <!-- count update bằng JS -->
                    <span class="text-muted small" id="tepCount"
                      th:text="${baiViet.dsTep != null ? baiViet.dsTep.size() : 0} + ' tệp'">0 tệp</span>
                  </div>

                  <div class="card-body">

                    <div th:if="${baiViet.dsTep == null or #sets.isEmpty(baiViet.dsTep)}" class="text-muted small">
                      Chưa có tệp đính kèm.
                    </div>

                    <!-- ✅ Chips tệp hiện có -->
                    <div th:if="${baiViet.dsTep != null and !#sets.isEmpty(baiViet.dsTep)}">
                      <div id="tepChipWrap" class="d-flex flex-wrap gap-2">
                        <div class="badge rounded-pill text-bg-light border d-inline-flex align-items-center gap-2"
                          th:each="tep : ${baiViet.dsTep}" th:attr="data-id=${tep.id}">
                          <span class="badge text-bg-light border" th:text="${tep.loaiTep}">FILE</span>

                          <a class="text-decoration-none small text-truncate" style="max-width: 180px;"
                            th:href="@{${tep.duongDanUrl}}" target="_blank" th:text="${tep.tenTep}">
                            ten tep
                          </a>

                          <button type="button" class="btn-close btn-close-sm js-remove-tep"
                            aria-label="Remove"></button>
                        </div>
                      </div>

                      <div class="form-text mt-2">
                        Bấm <b>x</b> để đánh dấu xoá, rồi bấm <b>Lưu</b>.
                      </div>

                      <!-- ✅ Hidden inputs để submit xoá -->
                      <div id="tepXoaHidden"></div>
                    </div>

                    <hr class="my-3">

                    <!-- ✅ Upload thêm: show chip file mới -->
                    <label class="form-label fw-semibold">Thêm tệp mới</label>
                    <input type="file" name="files" id="filesInput" class="form-control" multiple>

                    <div class="form-text">Chọn nhiều file (ảnh/video/tài liệu). Bấm x để bỏ file khỏi danh sách chọn.
                    </div>

                    <!-- chips file mới -->
                    <div id="newFilesWrap" class="d-flex flex-wrap gap-2 mt-2"></div>

                  </div>
                </div>


              </div>
            </div>
          </form>

        </div>
      </main>

      <footer th:replace="admin/layouts/footer::footer"></footer>
    </div>
  </div>

  <!-- JS vendor -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    crossorigin="anonymous"></script>
  <script th:src="@{/assets/js/scripts.js}"></script>

  <!-- JS page (tách riêng cho sạch) -->
  <script>
    (() => {
      // ====== DANH MỤC (giữ nguyên code bạn đang có) ======
      const chipWrap = document.getElementById('chipWrap');
      const dmHidden = document.getElementById('dmHidden');
      const btnApply = document.getElementById('btnApDungDm');

      if (chipWrap && dmHidden) {
        const getChecked = () => Array.from(document.querySelectorAll('.dm-checkbox:checked'));

        const rebuildHiddenFromChecked = () => {
          dmHidden.innerHTML = '';
          getChecked().forEach(cb => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'danhMucIds';
            input.value = cb.value;
            dmHidden.appendChild(input);
          });
        };

        const rebuildChipsFromChecked = () => {
          chipWrap.innerHTML = '';
          getChecked().forEach(cb => {
            const label = document.querySelector(`label[for="${cb.id}"]`);
            const labelText = label?.innerText?.trim() || `DM ${cb.value}`;

            const chip = document.createElement('div');
            chip.className = 'badge rounded-pill text-bg-light border d-inline-flex align-items-center gap-2';
            chip.dataset.id = cb.value;

            const sp = document.createElement('span');
            sp.innerText = labelText;

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn-close btn-close-sm js-remove-chip';
            btn.setAttribute('aria-label', 'Remove');

            chip.appendChild(sp);
            chip.appendChild(btn);
            chipWrap.appendChild(chip);
          });
        };

        btnApply?.addEventListener('click', () => {
          rebuildChipsFromChecked();
          rebuildHiddenFromChecked();
        });

        chipWrap.addEventListener('click', (e) => {
          const target = e.target;
          if (!(target instanceof HTMLElement)) return;
          if (!target.classList.contains('js-remove-chip')) return;

          const chip = target.closest('[data-id]');
          const id = chip?.getAttribute('data-id');
          if (!id) return;

          const cb = document.querySelector(`.dm-checkbox[value="${id}"]`);
          if (cb) cb.checked = false;

          chip.remove();
          rebuildHiddenFromChecked();
        });
      }

      // ====== TỆP ĐÍNH KÈM: CHIP + X => hidden xoaTepIds ======
      const tepChipWrap = document.getElementById('tepChipWrap');
      const tepXoaHidden = document.getElementById('tepXoaHidden');
      const tepCount = document.getElementById('tepCount');

      const updateTepCount = () => {
        if (!tepCount) return;
        const count = tepChipWrap ? tepChipWrap.querySelectorAll('[data-id]').length : 0;
        tepCount.innerText = `${count} tệp`;
      };

      if (tepChipWrap && tepXoaHidden) {
        tepChipWrap.addEventListener('click', (e) => {
          const target = e.target;
          if (!(target instanceof HTMLElement)) return;
          if (!target.classList.contains('js-remove-tep')) return;

          const chip = target.closest('[data-id]');
          const id = chip?.getAttribute('data-id');
          if (!id) return;

          // append hidden input để server xoá
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'xoaTepIds';
          input.value = id;
          tepXoaHidden.appendChild(input);

          // remove khỏi UI như danh mục
          chip.remove();
          updateTepCount();
        });

        updateTepCount();
      }

      // ====== FILE MỚI: show chip + cho xoá khỏi file input (DataTransfer) ======
      const filesInput = document.getElementById('filesInput');
      const newFilesWrap = document.getElementById('newFilesWrap');

      if (filesInput && newFilesWrap) {
        const dt = new DataTransfer();

        const fileKey = (f) => `${f.name}__${f.size}__${f.lastModified}`;

        const renderNewFiles = () => {
          newFilesWrap.innerHTML = '';
          Array.from(dt.files).forEach((f) => {
            const chip = document.createElement('div');
            chip.className = 'badge rounded-pill text-bg-light border d-inline-flex align-items-center gap-2';
            chip.dataset.key = fileKey(f);

            const sp = document.createElement('span');
            sp.className = 'small text-truncate';
            sp.style.maxWidth = '240px';
            sp.innerText = f.name;

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn-close btn-close-sm js-remove-newfile';
            btn.setAttribute('aria-label', 'Remove');

            chip.appendChild(sp);
            chip.appendChild(btn);
            newFilesWrap.appendChild(chip);
          });
        };

        const syncInputFiles = () => {
          filesInput.files = dt.files;
        };

        filesInput.addEventListener('change', () => {
          const selected = Array.from(filesInput.files);

          // add vào dt, tránh duplicate
          const existingKeys = new Set(Array.from(dt.files).map(fileKey));
          selected.forEach(f => {
            const k = fileKey(f);
            if (!existingKeys.has(k)) dt.items.add(f);
          });

          syncInputFiles();
          renderNewFiles();
        });

        newFilesWrap.addEventListener('click', (e) => {
          const target = e.target;
          if (!(target instanceof HTMLElement)) return;
          if (!target.classList.contains('js-remove-newfile')) return;

          const chip = target.closest('[data-key]');
          const key = chip?.getAttribute('data-key');
          if (!key) return;

          // rebuild dt trừ file bị xoá
          const keep = Array.from(dt.files).filter(f => fileKey(f) !== key);
          dt.items.clear();
          keep.forEach(f => dt.items.add(f));

          syncInputFiles();
          renderNewFiles();
        });
      }

      // ====== BOOTSTRAP VALIDATION ======
      const forms = document.querySelectorAll('.needs-validation');
      Array.from(forms).forEach(form => {
        form.addEventListener('submit', (event) => {
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
    })();


  </script>

</body>

</html>